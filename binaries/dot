#!/usr/bin/env bash

set -e
export DOTFILES="$HOME/.dotfiles"
cd "$DOTFILES"

display_usage_and_exit() {
  echo "dot -- dotfiles maintenance"
  echo ""
  echo "Usage: dot [options]"
  echo ""
  echo "Options:"
  echo "  -e, --edit    Open the dotfiles directory in an editor"
  echo "  -h, --help    Show this help message and exit"
  echo "  -d, --dump    Update lists of installed packages (brew, code)"
  echo "  -c, --chmod   Fix file permissions in the dotfiles repository"
  exit
}

while test $# -gt 0; do
  case "$1" in
    "-h"|"--help")
      display_usage_and_exit
      ;;
    "-e"|"--edit")
      exec "$EDITOR" "$DOTFILES"
      exit
      ;;
    "-d"|"--dump")
      brew bundle dump --force --file="$DOTFILES/topics/brew/Brewfile"
      code --list-extensions > "$DOTFILES/topics/code/extensions.txt"
      exit
      ;;
    "-c"|"--chmod")
      find "$DOTFILES/scripts" -type f -exec chmod +x {} \;
      find "$DOTFILES/binaries" -type f -exec chmod +x {} \;
      find "$DOTFILES/functions" -type f -iname "*.fish" -exec chmod +x {} \;
      find "$DOTFILES/topics" -iname "*.fish" -or -iname "*.sh" -exec chmod +x {} \;
      find "$DOTFILES/topics" -iname "*hook*" -exec chmod +x {} \;
      exit
      ;;
    *)
      echo "Invalid option: $1"
      display_usage_and_exit
      ;;
  esac
  shift
done

./init.sh

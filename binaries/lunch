#!/usr/bin/env node

const puppeteer = require("puppeteer");

const restaurants = {
  // ============================== PIVO KARLÍN ==============================
  async "Pivo Karlín"(page) {
    await page.goto("https://www.pivokarlin.cz/");

    return page.evaluate(() =>
      Array.from(
        document.querySelectorAll("#menuModala .carousel-item:first-child .row")
      ).map(row => row.querySelector("p").firstChild.textContent)
    );
  },
  // ============================== GLOBUS ==============================
  async Globus(page) {
    await page.goto("https://restauraceglobus.cz/poledni-menu/");

    return page.evaluate(() => {
      const daysOfWeek = ["Pondělí", "Úterý", "Středa", "Čtvrtek", "Pátek"];

      return (
        Array.from(document.querySelectorAll(".entry-content p")).reduce(
          (weeklyMenu, paragraph) => {
            const content = paragraph.firstChild.textContent;

            if (daysOfWeek.includes(content)) {
              return [...weeklyMenu, []];
            }

            if (weeklyMenu.length) {
              return [
                ...weeklyMenu.slice(0, -1),
                [...weeklyMenu[weeklyMenu.length - 1], content]
              ];
            }

            return weeklyMenu;
          },
          []
        )[new Date().getDay() - 1] || []
      ).map(meal => meal.replace(/\s+/g, " "));
    });
  },
  // ============================== ÉČKO ==============================
  async Éčko(page) {
    await page.goto(
      "https://www.prague-catering.cz/provozovny/Kantyna-ECKO/Denni-menu-kantyny-ECKO/"
    );

    return page.evaluate(() => {
      let insideMainCourses = false;

      return Array.from(
        document.querySelectorAll(".dennimenu tbody tr")
      ).reduce((menu, row) => {
        const cell = row.firstChild;
        const heading =
          cell.firstChild && cell.firstChild.tagName === "H3"
            ? cell.firstChild
            : null;

        if (!heading) {
          if (insideMainCourses) {
            return [...menu, cell.textContent];
          }

          return menu;
        }

        insideMainCourses = heading.textContent.includes("Hlavní");

        return menu;
      }, []);
    });
  },
  // ============================== DÍRA ==============================
  async Díra(page) {
    await page.goto(
      "https://www.prague-catering.cz/provozovny/jidelna-kantyna-praha/jidelna-denni-menu-praha-8/"
    );

    return page.evaluate(() => {
      let insideMainCourses = false;

      return Array.from(
        document.querySelectorAll(".dennimenu tbody tr")
      ).reduce((menu, row) => {
        const cell = row.firstChild;
        const heading =
          cell.firstChild && cell.firstChild.tagName === "H3"
            ? cell.firstChild
            : null;

        if (!heading) {
          if (insideMainCourses) {
            return [...menu, cell.textContent];
          }

          return menu;
        }

        insideMainCourses = heading.textContent.includes("Hlavní");

        return menu;
      }, []);
    });
  }
};

// ============================== RUNTIME ==============================
(async () => {
  const browser = await puppeteer.launch();

  await Promise.all(
    Object.entries(restaurants).map(async ([name, getMenu]) => {
      try {
        const page = await browser.newPage();
        const menu = await getMenu(page);

        console.info(name, menu);
      } catch (error) {
        console.error(`An error occurred when retrieving ${name} menu.`);
        console.error(error);
      }
    })
  );

  await browser.close();
})();

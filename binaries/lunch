#!/usr/bin/env node

const puppeteer = require("puppeteer");

(async () => {
  const browser = await puppeteer.launch();
  const page = await browser.newPage();

  await page.goto("https://www.pivokarlin.cz/");

  console.log(
    "Pivo Karlín",
    await page.evaluate(() =>
      Array.from(
        document.querySelectorAll("#menuModala .carousel-item:first-child .row")
      ).map(row => row.querySelector("p").firstChild.textContent)
    )
  );

  await page.goto("https://restauraceglobus.cz/poledni-menu/");

  console.log(
    "Globus",
    await page.evaluate(() => {
      const daysOfWeek = ["Pondělí", "Úterý", "Středa", "Čtvrtek", "Pátek"];

      return Array.from(document.querySelectorAll(".entry-content p"))
        .reduce((weeklyMenu, paragraph) => {
          const content = paragraph.firstChild.textContent;

          if (daysOfWeek.includes(content)) {
            return [...weeklyMenu, []];
          }

          if (weeklyMenu.length) {
            return [
              ...weeklyMenu.slice(0, -1),
              [...weeklyMenu[weeklyMenu.length - 1], content]
            ];
          }

          return weeklyMenu;
        }, [])
        [new Date().getDay() - 1].map(meal => meal.replace(/\s+/g, " "));
    })
  );

  await page.goto(
    "https://www.prague-catering.cz/provozovny/Kantyna-ECKO/Denni-menu-kantyny-ECKO/"
  );

  console.log(
    "Éčko",
    await page.evaluate(() => {
      let insideMainCourses = false;

      return Array.from(
        document.querySelectorAll(".dennimenu tbody tr")
      ).reduce((menu, row) => {
        const cell = row.firstChild;
        const heading =
          cell.firstChild && cell.firstChild.tagName === "H3"
            ? cell.firstChild
            : null;

        if (!heading) {
          if (insideMainCourses) {
            return [...menu, cell.textContent];
          }

          return menu;
        }

        insideMainCourses = heading.textContent.includes("Hlavní");

        return menu;
      }, []);
    })
  );

  await page.goto(
    "https://www.prague-catering.cz/provozovny/jidelna-kantyna-praha/jidelna-denni-menu-praha-8/"
  );

  console.log(
    "Díra",
    await page.evaluate(() => {
      let insideMainCourses = false;

      return Array.from(
        document.querySelectorAll(".dennimenu tbody tr")
      ).reduce((menu, row) => {
        const cell = row.firstChild;
        const heading =
          cell.firstChild && cell.firstChild.tagName === "H3"
            ? cell.firstChild
            : null;

        if (!heading) {
          if (insideMainCourses) {
            return [...menu, cell.textContent];
          }

          return menu;
        }

        insideMainCourses = heading.textContent.includes("Hlavní");

        return menu;
      }, []);
    })
  );

  await browser.close();
})();
